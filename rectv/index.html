<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INADINA TV</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --hue: 345; --primary: hsl(var(--hue), 100%, 50%); --bg: #0f0a1a; --surface: #1a1825; --text: #e8e6e3; --card-bg: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.03); }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; margin: 0; padding-bottom: 20px; transition: background 0.3s, color 0.3s; }
        body.light-theme { --bg: #f5f5f5; --surface: #ffffff; --text: #1a1a1a; --card-bg: #ffffff; --border: #e0e0e0; }
        
        .top-bar { padding: 15px 20px; background: var(--surface); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:100; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: background 0.3s; }
        .logo { font-size: 1.4rem; font-weight: 800; background: linear-gradient(135deg, #ff0040, #ff4d00); -webkit-background-clip: text; color: transparent; }
        
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .theme-btn { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; transition: all 0.3s; }
        .light-theme .theme-btn { background: rgba(0, 0, 0, 0.05); border-color: rgba(0, 0, 0, 0.1); color: #1a1a1a; }
        
        .online-badge { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: rgba(0, 255, 127, 0.1); border: 1px solid rgba(0, 255, 127, 0.2); border-radius: 8px; font-size: 0.8rem; font-weight: bold; color: #00ff7f; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 5px rgba(0,255,127,0.5); } 100% { opacity: 0.8; } }

        .announcement-bar { background: #ffeb3b; color: #000; overflow: hidden; white-space: nowrap; padding: 6px 0; font-weight: bold; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: none; border-bottom: 2px solid #ff4d00; }
        .announcement-content { display: inline-block; padding-left: 100%; animation: scroll-left 15s linear infinite; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        .container { padding: 15px; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 10px; margin-bottom: 12px; display: flex; align-items: center; cursor: pointer; border: 1px solid var(--border); position: relative; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card.hidden { display: none; }
        .light-theme .card { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .img-box { position: relative; width: 55px; height: 55px; flex-shrink: 0; }
        .card-img { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; }
        .badge { position: absolute; top: -8px; right: -8px; font-size: 0.65rem; padding: 3px 8px; border-radius: 6px; font-weight: 800; z-index: 10; animation: pulse-glow 2s infinite ease-in-out; }
        .badge-iptv { background: linear-gradient(135deg, #00d2ff, #3a7bd5); color: #fff; }
        @keyframes pulse-glow { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .card-info { flex: 1; margin-left: 12px; }
        .card-name { font-weight: 700; font-size: 1rem; margin-bottom: 3px; color: var(--text); }
        .card-meta { font-size: 0.75rem; opacity: 0.5; color: var(--text); display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        .stat-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(255, 255, 255, 0.05); padding: 2px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 600; border: 1px solid rgba(255, 255, 255, 0.1); }
        .light-theme .stat-badge { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); }
        .stat-eye { color: var(--primary); }
        .stat-heart { color: #ff3d3d; cursor: pointer; transition: transform 0.2s; }
        .stat-heart.liked { color: #ff0000; text-shadow: 0 0 10px rgba(255,0,0,0.5); transform: scale(1.2); }
        .play-icon { color: var(--primary); font-size: 1.4rem; margin-left: 10px; }

        .load-more-btn { width: calc(100% - 30px); margin: 20px 15px; padding: 15px; border: none; border-radius: 15px; background: linear-gradient(135deg, var(--primary), #ff4d00); color: white; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255, 0, 64, 0.3); }
        .load-more-btn.hidden { display: none; }
        
        .toast { visibility: hidden; min-width: 250px; background-color: #1a1825; border: 1px solid rgba(255,255,255,0.1); color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 0.9rem; box-shadow: 0 5px 20px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s, bottom 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .toast.show { visibility: visible; opacity: 1; bottom: 90px; }

        /* CHAT FULL STYLES */
        .chat-btn { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, #00d2ff, #3a7bd5); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 200; }
        
        .chat-modal { position: fixed; bottom: -100%; left: 0; width: 100%; height: 96%; background: var(--surface); border-radius: 20px 20px 0 0; z-index: 201; transition: bottom 0.4s; display: flex; flex-direction: column; box-shadow: 0 -5px 30px rgba(0,0,0,0.5); }
        .chat-modal.active { bottom: 0; }
        .chat-tabs { display: flex; width: 100%; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 2px; }
        .chat-tab { flex: 1; text-align: center; padding: 8px; font-size: 0.9rem; cursor: pointer; border-radius: 8px; transition: all 0.3s; }
        .chat-tab.active { background: var(--primary); color: white; font-weight: bold; }
        
        .chat-view { display: flex; flex-direction: column; flex: 1; overflow: hidden; }
        .chat-view.hidden { display: none; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message-bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; position: relative; word-wrap: break-word; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .msg-left { align-self: flex-start; background: rgba(255,255,255,0.1); border-bottom-left-radius: 2px; }
        .msg-right { align-self: flex-end; background: var(--primary); border-bottom-right-radius: 2px; }
        .msg-user { font-size: 0.7rem; opacity: 0.7; margin-bottom: 2px; display: block; font-weight: bold; cursor:pointer; }
        .msg-admin { color: #ffeb3b; }
        
        .chat-input-area { padding: 10px; display: flex; gap: 10px; background: rgba(0,0,0,0.2); }
        .chat-input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; background: rgba(255,255,255,0.1); color: var(--text); }
        .light-theme .chat-input { background: white; color: black; }
        
        .private-chat-item { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        .action-menu-btn { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: var(--text); font-size: 1rem; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 10px; }

        /* ADMIN & MODAL STYLES */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; display:none; justify-content:center; align-items:center; }
        .modal-box { background: var(--surface); width: 85%; max-width: 380px; border-radius: 20px; padding: 20px; border: 1px solid var(--border); position: relative; }
        
        .admin-panel-btn { position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #ff0040; border-radius: 50%; display: none; justify-content: center; align-items: center; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.5); cursor: pointer; z-index: 200; }
        #adminPanelModal .modal-box { display: flex; flex-direction: column; max-height: 90vh; padding-bottom: 60px; }
        .admin-modal-body { overflow-y: auto; text-align: left; padding-right: 5px; flex: 1; }
        .admin-menu-btn { background: rgba(255,255,255,0.08); padding: 12px; border-radius: 10px; margin-top: 15px; color: #ffeb3b; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255, 235, 59, 0.3); }
        .light-theme .admin-menu-btn { background: #fff; border-color: #ccc; color: #333; }
        .admin-submenu { display: none; margin-top: 10px; padding-left: 5px; border-left: 2px solid #ffeb3b; }
        .admin-submenu.active { display: block; animation: slideDown 0.3s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-input { width: 90%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: white; outline: none; }
        .light-theme .custom-input { background: white; color: black; border-color: #ccc; }
        .btn-confirm { background: #ff0040; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-cancel { background: #444; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
        .btn-shorten { background: #00d2ff; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; width: 100%; justify-content: center; }

        .channel-item-admin { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .light-theme .channel-item-admin { background: #eee; }
        .channel-actions { display: flex; gap: 5px; }
        .btn-sm { padding: 5px 10px; border-radius: 5px; border: none; color: white; cursor: pointer; font-size: 0.8rem; }
        .btn-edit { background: #2196F3; }
        .btn-del { background: #f44336; }
        
        .player-opt { display: flex; align-items: center; padding: 15px; margin: 8px 0; border-radius: 12px; background: rgba(255,255,255,0.05); gap: 15px; cursor: pointer; color: white; }
        .light-theme .player-opt { background: rgba(0,0,0,0.05); color: #1a1a1a; }
        
        /* BANNED SCREEN */
        .banned-screen { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:5000; color:red; flex-direction:column; justify-content:center; align-items:center; text-align:center; font-size:1.5rem; font-weight:bold; }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <!-- BAKIM MODU -->
    <div id="maintenanceScreen" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#111; z-index:9000; color:#ffeb3b; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
        <i class="fas fa-tools" style="font-size:4rem; margin-bottom:20px;"></i>
        <h1>BAKIM MODU</h1>
        <p>Sistem g√ºncelleniyor...</p>
        <input type="password" id="emergencyPass" class="custom-input" placeholder="Y√∂netici ≈ûifresi" style="width:200px; text-align:center;">
        <button onclick="emergencyLogin()" class="btn-confirm" style="width:auto;">Giri≈ü Yap</button>
    </div>

    <!-- ENGEL EKRANI -->
    <div id="bannedScreen" class="banned-screen">
        <i class="fas fa-ban" style="font-size:4rem; margin-bottom:20px;"></i>
        <div>ENGELLENDƒ∞Nƒ∞Z</div>
        <div style="font-size:1rem; color:white; margin-top:10px;">Sohbet kurallarƒ±na uymadƒ±ƒüƒ±nƒ±z i√ßin eri≈üiminiz kapatƒ±ldƒ±.</div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanelModal" class="modal">
        <div class="modal-box">
            <h3 style="text-align:center; color:#ff0040; margin-top:0;">üõ°Ô∏è Y√∂netici Paneli</h3>
            <div class="admin-modal-body">
                
                <!-- KANAL Y√ñNETƒ∞Mƒ∞ -->
                <div class="admin-menu-btn" onclick="toggleSubMenu('channelAdmin')">
                    <span>üì∫ Kanal Y√∂netimi</span> <i class="fas fa-chevron-down"></i>
                </div>
                <div id="channelAdmin" class="admin-submenu">
                    <h4 style="color:#aaa; margin:10px 0 5px;">Yeni Kanal Ekle</h4>
                    <input type="text" id="addTitle" class="custom-input" placeholder="Kanal Adƒ±">
                    <input type="text" id="addM3u" class="custom-input" placeholder="M3U / Yayƒ±n Linki">
                    
                    <input type="text" id="addWeb" class="custom-input" placeholder="Web / ƒ∞ndirme Linki (Otomatik Kƒ±saltƒ±lƒ±r)">
                    <button class="btn-shorten" onclick="shortenUrl('addWeb')"><i class="fas fa-link"></i> Manuel Link Kƒ±salt</button>
                    
                    <input type="text" id="addImg" class="custom-input" placeholder="ƒ∞kon URL">
                    <input type="number" id="addOrder" class="custom-input" placeholder="Sƒ±ra No (√ñrn: 10)">
                    <button onclick="addNewChannel()" class="btn-confirm"><i class="fas fa-plus"></i> Ekle</button>
                    
                    <h4 style="color:#aaa; margin:15px 0 5px;">Mevcut Kanallar</h4>
                    <div id="adminChannelList" style="max-height:200px; overflow-y:auto;">
                        <p style="text-align:center; opacity:0.5;">Y√ºkleniyor...</p>
                    </div>
                </div>

                <!-- Dƒ∞ƒûER AYARLAR -->
                <div class="admin-menu-btn" onclick="toggleSubMenu('annoAdmin')"><span>üì¢ Duyuru Paneli</span> <i class="fas fa-chevron-down"></i></div>
                <div id="annoAdmin" class="admin-submenu">
                    <input type="text" id="annoInput" class="custom-input" placeholder="Kayan Yazƒ± Metni">
                    <button onclick="saveAnnouncement()" class="btn-confirm">Yayƒ±nla</button>
                    <button onclick="stopAnnouncement()" class="btn-cancel">Kaldƒ±r</button>
                </div>
                
                <div class="admin-menu-btn" onclick="toggleSubMenu('settingsContainer')"><span>‚öôÔ∏è Genel Ayarlar</span> <i class="fas fa-chevron-down"></i></div>
                <div id="settingsContainer" class="admin-submenu">
                    <button class="btn-cancel" onclick="toggleMaintenance()">üöß Bakƒ±m Modu A√ß/Kapa</button>
                    <button class="btn-cancel" onclick="clearChat()" style="background:#d32f2f;">üóëÔ∏è Sohbeti Temizle</button>
                    <button class="btn-confirm" onclick="restoreBackup()" style="background:#2196F3; margin-top:15px;">üìÇ Eski Listeyi Y√ºkle (JSON)</button>
                    <p style="font-size:0.7rem; color:#aaa; margin-top:5px;">*Listeleriniz bo≈ü g√∂r√ºn√ºyorsa buna basƒ±n.</p>
                </div>
            </div>
            <button onclick="document.getElementById('adminPanelModal').style.display='none'" class="btn-cancel">Kapat</button>
        </div>
    </div>

    <!-- KULLANICI ƒ∞≈ûLEM MODALI -->
    <div id="userActionModal" class="modal">
        <div class="modal-box">
            <h3 id="uaTitle" style="color:var(--primary); margin-top:0;">Kullanƒ±cƒ± ƒ∞≈ülemleri</h3>
            <button class="action-menu-btn" onclick="executeUserAction('private')"><i class="fas fa-lock"></i> √ñzel Mesaj At</button>
            <div id="adminUserActions" style="display:none; border-top:1px solid rgba(255,255,255,0.1); margin-top:5px; padding-top:5px;">
                <button class="action-menu-btn" onclick="executeUserAction('ban')" style="color:#ff4d4d;"><i class="fas fa-ban"></i> Engelle</button>
                <button class="action-menu-btn" onclick="executeUserAction('delete')" style="color:#aaa;"><i class="fas fa-trash"></i> Mesajƒ± Sil</button>
            </div>
            <button class="btn-cancel" onclick="document.getElementById('userActionModal').style.display='none'" style="width:100%; margin-top:10px;">Kapat</button>
        </div>
    </div>

    <!-- D√úZENLEME MODALI -->
    <div id="editChannelModal" class="modal">
        <div class="modal-box">
            <h3>Kanal D√ºzenle</h3>
            <input type="hidden" id="editKey">
            <input type="text" id="editTitle" class="custom-input" placeholder="Ba≈ülƒ±k">
            <input type="text" id="editM3u" class="custom-input" placeholder="M3U URL">
            
            <input type="text" id="editWeb" class="custom-input" placeholder="Web URL">
            <button class="btn-shorten" onclick="shortenUrl('editWeb')"><i class="fas fa-link"></i> Linki Kƒ±salt</button>

            <input type="text" id="editImg" class="custom-input" placeholder="Resim URL">
            <input type="number" id="editOrder" class="custom-input" placeholder="Sƒ±ra No">
            <button onclick="saveChannelEdit()" class="btn-confirm">Kaydet</button>
            <button onclick="document.getElementById('editChannelModal').style.display='none'" class="btn-cancel">ƒ∞ptal</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="logo">INADINA TV</div>
        <div class="header-actions">
            <div class="online-badge" title="Online Sayƒ±sƒ±"><i class="fas fa-users"></i> <span id="onlineCount">0</span></div>
            <button class="theme-btn" onclick="toggleTheme()" id="themeBtn"><i class="fas fa-moon"></i></button>
            <a href="https://t.me/inadinatv" id="telegramBtn" style="color:white; font-size:1.4rem;"><i class="fab fa-telegram"></i></a>
        </div>
    </div>

    <div id="announcementBar" class="announcement-bar"><div class="announcement-content" id="announcementText"></div></div>

    <div class="container"><div id="list"></div></div>
    <button class="load-more-btn" id="loadMoreBtn" onclick="loadMore()">Daha Fazla G√∂ster</button>

    <div class="chat-btn" onclick="toggleChat()"><i class="fas fa-comment-dots"></i></div>
    <div class="admin-panel-btn" id="adminBtn" onclick="openAdminPanel()"><i class="fas fa-shield-alt"></i></div>

    <!-- SOHBET MODAL -->
    <div class="chat-modal" id="chatModal">
        <div style="padding:15px; display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2);">
            <div style="display:flex; align-items:center; gap:10px;">
                <span id="chatStatus" style="font-weight:bold;">Canlƒ± Sohbet üü¢</span>
                <i class="fas fa-edit" onclick="openNameModal()" style="cursor:pointer; opacity:0.7; font-size:0.9rem;"></i>
            </div>
            <i class="fas fa-times" onclick="toggleChat()" style="cursor:pointer; font-size:1.5rem;"></i>
        </div>
        
        <div class="chat-tabs">
            <div class="chat-tab active" id="tabGlobal" onclick="switchChatTab('global')">Genel</div>
            <div class="chat-tab" id="tabPrivate" onclick="switchChatTab('private')">√ñzel Mesaj <span id="pmBadge" style="background:red; border-radius:50%; font-size:0.6rem; padding:2px 5px; display:none;">!</span></div>
        </div>

        <!-- GLOBAL SOHBET -->
        <div id="viewGlobal" class="chat-view">
            <div class="chat-messages" id="chatContainer"></div>
        </div>

        <!-- √ñZEL SOHBET Lƒ∞STESƒ∞ -->
        <div id="viewPrivateList" class="chat-view hidden">
            <div class="chat-messages" id="privateChatListContainer"></div>
        </div>
        
        <!-- √ñZEL SOHBET KONU≈ûMA -->
        <div id="viewPrivateConv" class="chat-view hidden">
            <div style="background:rgba(0,0,0,0.3); padding:8px; display:flex; align-items:center;">
                <button onclick="backToPrivateList()" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i class="fas fa-arrow-left"></i></button>
                <span id="privateChatUserName" style="margin-left:15px; font-weight:bold;">Kullanƒ±cƒ±</span>
            </div>
            <div class="chat-messages" id="privateChatContainer"></div>
        </div>

        <div class="chat-input-area">
            <input type="text" class="chat-input" id="msgInput" placeholder="Mesaj yaz...">
            <button onclick="sendMsg()" style="width:40px; height:40px; border-radius:50%; background:var(--primary); color:white; border:none; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    
    <!-- ƒ∞Sƒ∞M DEƒûƒ∞≈ûTƒ∞RME -->
    <div id="nameChangeModal" class="modal">
        <div class="modal-box">
            <h3>ƒ∞sim Deƒüi≈ütir</h3>
            <input type="text" id="newNameInput" class="custom-input" placeholder="Yeni ƒ∞sminiz">
            <button onclick="saveName()" class="btn-confirm">Kaydet</button>
            <button onclick="document.getElementById('nameChangeModal').style.display='none'" class="btn-cancel">ƒ∞ptal</button>
        </div>
    </div>

    <!-- OYNATICI SE√áƒ∞M MODAL -->
    <div class="modal" id="modal">
        <div class="modal-box">
            <h3 id="mTitle" style="text-align:center; color:var(--primary);"></h3>
            <div class="player-opt" id="wuffy"><i class="fas fa-play"></i> Wuffy Player</div>
            <div class="player-opt" id="xpola"><i class="fas fa-rocket"></i> Xpola Player</div>
            <div class="player-opt" id="externalWeb" style="border:1px solid #ffab00; color:#ffab00;"><i class="fas fa-external-link-alt"></i> Tarayƒ±cƒ±da A√ß / ƒ∞ndir</div>
            <button onclick="document.getElementById('modal').style.display='none'" class="btn-cancel">Vazge√ß</button>
        </div>
    </div>

    <script>
        // PYTHON TARAFINDAN G√ñNDERƒ∞LEN BA≈ûLANGI√á VERƒ∞Sƒ∞
        const backupJsonData = [{"title": "SUPMOT ƒ∞PTV ƒ∞NDƒ∞R", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/supmot-iptv.m3u", "web_link_url": "https://ay.live/sBLi", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "19.01.2026"}, {"title": "10 ADET MAC ADRESƒ∞ ƒ∞PTV", "m3u_url": "https://file.garden/aMCMLdwOhlHjDvvq/inadinamackod.m3u", "web_link_url": "https://ay.live/ZZ5c", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "18.01.2026"}, {"title": "KRƒ∞STAL ƒ∞PTV EKLENDƒ∞", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/Kristal-iptv-W.m3u", "web_link_url": "https://ay.live/8Gxpf", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "18.01.2026"}, {"title": "SMARTES2 ƒ∞PTV", "m3u_url": "http://smartzone1.xyz:8080/get.php?username=zrdQ5UHD&password=q82fkQT&type=m3u_plus", "web_link_url": "https://ay.live/xAdwL", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "17.01.2026"}, {"title": "10 Bƒ∞N Kƒ∞Sƒ∞Lƒ∞K ƒ∞PTV", "m3u_url": "https://broken-night-dffb.deathlesstelenyu.workers.dev/dth-iptv.m3u", "web_link_url": "https://ay.live/QfCR", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "16.01.2026"}, {"title": "SMART ƒ∞PTV", "m3u_url": "http://smartzone1.xyz:8080/get.php?username=utSzxq7SY6&password=dj1yyFAQJy&type=m3u_plus", "web_link_url": "https://ay.live/5kQj", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "15.01.2026"}, {"title": "YENƒ∞ SPORT ƒ∞PTV", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/sport-connec.m3u", "web_link_url": "https://ay.live/Ry1l", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "14.01.2026"}, {"title": "10 Sƒ∞Nƒ∞RSƒ∞Z ƒ∞PTV M3U", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/megaiptv-X.m3u", "web_link_url": "https://ay.live/7LxRP8", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "13.01.2026"}, {"title": "SMARTZONE ƒ∞PTV", "m3u_url": "http://smartzone1.xyz:8080/get.php?username=gRNhEpGh3m&password=fmaAdfkHXJ&type=m3u_plus", "web_link_url": "https://ay.live/q9fMZa", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "12.01.2026"}, {"title": "MEGA ƒ∞PTV ƒ∞NDƒ∞R", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/megaiptv-X.m3u", "web_link_url": "https://ay.live/G7TFl", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "11.01.2026"}, {"title": "1500 MAX SPORTS ƒ∞PTV", "m3u_url": "https://file.garden/aMCMLdwOhlHjDvvq/nadina-1500-Max-iptv.m3u", "web_link_url": "https://ay.live/Se6xQ", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "09.01.2026"}, {"title": "QUANTUM ƒ∞PTV Lƒ∞ST", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/Kuantum-iptv.m3u", "web_link_url": "https://ay.live/8Xy9", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "08.01.2026"}, {"title": "FULL BOT ƒ∞PTV SPORTS", "m3u_url": "https://deathless.short.gy/Full-Bot-iptv.m3u", "web_link_url": "https://ay.live/ld7M", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "07.01.2026"}, {"title": "Ekalite iptv m3u", "m3u_url": "http://ekalite.xyz:8080/get.php?username=ibrahimtak&password=qwkRZHAwaK&type=m3u_plus", "web_link_url": "https://ay.live/4eoXDj", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "06.01.2026"}, {"title": "D SPORTS M3U ADRESƒ∞ EKLEND", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/DTH-Sports.m3u", "web_link_url": "https://ay.live/w2Avb", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "05.01.2026"}, {"title": "30 ADET ƒ∞PTV M3U Lƒ∞STE", "m3u_url": "http://maisonxp.click/get.php?username=thay123&password=thay123&type=m3u", "web_link_url": "https://ay.live/zcn3j7", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "04.01.2026"}, {"title": "ELƒ∞TE MAC ADRESLERƒ∞ ƒ∞PTV", "m3u_url": "https://file.garden/aMCMLdwOhlHjDvvq/playlist.m3u", "web_link_url": "https://ay.live/DfpE", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "04.01.2026"}, {"title": "KARMA ƒ∞PTV 23K", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/Karma-iptv.m3u", "web_link_url": "https://ay.live/6WmReB", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "03.01.2026"}, {"title": "Yeni iptv liste", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/DeaTHLesS-TG-iptv.m3u", "web_link_url": "https://ay.live/0cKg", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "02.01.2026"}, {"title": "Turkiye Connect iptv", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/Turkiye-iptv.m3u", "web_link_url": "https://ay.live/6Dr", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "01.01.2026"}, {"title": "9500 ƒ∞PTV M3U Lƒ∞NKLER Yƒ∞LBASƒ∞ OZEL", "m3u_url": "http://ss.wancolonel.xyz:8080/get.php?username=Denisurlu&password=Muri3091&type=m3u_plus", "web_link_url": "https://ay.live/3hJ9te", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "31.12.2025"}, {"title": "3 Adet ƒ∞ptv link", "m3u_url": "https://izleyici.aykara463.workers.dev/DeaTHLesS.m3u", "web_link_url": "https://ay.live/KCwKj", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "30.12.2025"}, {"title": "XTREAM ƒ∞PTV Lƒ∞STELER EKLENDƒ∞", "m3u_url": "http://s1.eldest99.xyz:8080/get.php?username=hdkaptantv3706&password=kptn@8723706&type=m3u_plus", "web_link_url": "https://ay.live/Clqz", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "29.12.2025"}, {"title": "Fƒ∞LM EKSENƒ∞ ƒ∞PTV", "m3u_url": "https://raw.githubusercontent.com/sultansmgr/smart/refs/heads/main/FilmEkseni.m3u", "web_link_url": "https://ay.live/qCS", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQESVvVD7PLGjrzbMvNGvIFOhRBoSxzoGBFLm3iG-xX1ZEArpkhkSItDVY&s=10", "added_date": "28.12.2025"}, {"title": "B. Conneckt ƒ∞ptv", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/b-connect.m3u", "web_link_url": "https://ay.live/67w", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "28.12.2025"}, {"title": "Spor Kanallari bot iptv", "m3u_url": "https://izleyici.aykara463.workers.dev/DeaTHLesS.m3u", "web_link_url": "https://ay.live/9GlX", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "27.12.2025"}, {"title": "100 Bin kisilik iptv", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/DeaTHLesS-TG-iptv.m3u", "web_link_url": "https://ay.live/6QE", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "27.12.2025"}, {"title": "Hibrit ƒ∞ptv", "m3u_url": "https://file.garden/Z-hq5n4Shk27aY58/Toplu-Paket-V.m3u", "web_link_url": "https://ay.live/eAAA7K", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "27.12.2025"}, {"title": "553 Adet iptv Liste", "m3u_url": "http://otom.191462.xyz:8080/get.php?username=Veritech319&password=Dtx10012023@&type=m3u_plus", "web_link_url": "https://ay.live/DGKU", "image": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10", "added_date": "27.12.2025"}];
        const LINK_API_KEY = "cce8efcdd2693c8adde90f05832332f7f30fbf41";

        const firebaseConfig = {
          apiKey: "AIzaSyCZFwiLcV4K3EnRDWpPPlXPrXSJxAuMfaQ",
          authDomain: "iptvbotcoun.firebaseapp.com",
          databaseURL: "https://iptvbotcoun-default-rtdb.firebaseio.com",
          projectId: "iptvbotcoun",
          storageBucket: "iptvbotcoun.firebasestorage.app",
          messagingSenderId: "229841892818",
          appId: "1:229841892818:web:a91dd3792919140a5d440b"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DEƒûƒ∞≈ûKENLER
        let categoryData = { iptv_list: { items: [] } };
        let activeCategoryKey = 'iptv_list';
        let itemsPerPage = 10; 
        let currentlyShown = itemsPerPage;
        let isAdmin = localStorage.getItem('is_admin') === 'true';
        let myUserName = localStorage.getItem('chat_username') || "Misafir_" + Math.floor(Math.random() * 9000 + 1000);
        let myUUID = localStorage.getItem('user_uuid') || 'user_' + Date.now();
        localStorage.setItem('user_uuid', myUUID);
        localStorage.setItem('chat_username', myUserName);
        
        let globalViewCounts = {};
        let globalLikeCounts = {};
        let myLikes = JSON.parse(localStorage.getItem('my_likes') || "[]");
        
        let currentTab = 'global';
        let currentPrivateRoom = null;
        let currentTargetUser = null;
        let selectedUserForAction = null;

        const ADMIN_PASS = "burhan_baba_72";
        const TG_BOT_TOKEN = "8437262061:AAGnhDFIjFqNL5PlUGS33mUaXEMlKd1yyzk";
        const TG_CHAT_ID = "666941331";

        function init() {
            listenToChannels();
            listenToStats();
            listenToExtras();
            listenToChat();
            listenToAllPrivateChats();
            initPresence();
            
            if(localStorage.getItem('theme') === 'light') toggleTheme();
            if(isAdmin) {
                document.getElementById('adminBtn').style.display = "flex";
                document.getElementById('chatStatus').innerText = "Y√∂netici üëÆ‚Äç‚ôÇÔ∏è";
            }
            render();
            checkBanStatus();
        }

        // --- MANUEL YEDEK Y√úKLEME ---
        window.restoreBackup = function() {
            if(confirm("Eski JSON listenizi Firebase'e y√ºklemek istiyor musunuz? Mevcut Firebase verileri silinmez, √ºzerine eklenir.")) {
                if (!backupJsonData || backupJsonData.length === 0) {
                    showToast("Yedek veri bulunamadƒ±!", "fa-exclamation");
                    return;
                }
                showToast("Y√ºkleniyor...", "fa-sync fa-spin");
                let counter = 0;
                backupJsonData.forEach((item, index) => {
                    database.ref('channels').push({
                        title: item.title,
                        m3u_url: item.m3u_url || "#",
                        web_link_url: item.web_link_url || "#",
                        image: item.image || "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10",
                        added_date: item.added_date || new Date().toLocaleDateString('tr-TR'),
                        order: index + 1
                    });
                    counter++;
                });
                showToast(counter + " Kanal Ba≈üarƒ±yla Y√ºklendi!", "fa-check");
            }
        };

        // --- KANAL Y√ñNETƒ∞Mƒ∞ ---
        function listenToChannels() {
            database.ref('channels').on('value', (snapshot) => {
                const data = snapshot.val();
                let items = [];
                if(data) {
                    items = Object.keys(data).map(key => { return { ...data[key], firebaseKey: key }; });
                    items.sort((a, b) => (a.order || 9999) - (b.order || 9999));
                }
                categoryData.iptv_list.items = items;
                render();
                if(isAdmin) renderAdminChannelList(items);
            });
        }

        async function addNewChannel() {
            const title = document.getElementById('addTitle').value;
            const m3u = document.getElementById('addM3u').value;
            let web = document.getElementById('addWeb').value;
            const img = document.getElementById('addImg').value;
            const order = document.getElementById('addOrder').value;

            if(!title) { showToast("Ba≈ülƒ±k zorunlu!", "fa-exclamation"); return; }
            if(web && web.startsWith('http')) {
                showToast("Link Kazan√ßlƒ± Hale Getiriliyor... ü§ë", "fa-cog fa-spin");
                try {
                    const apiUrl = `https://ay.live/api/?api=${LINK_API_KEY}&url=${encodeURIComponent(web)}&format=text`;
                    const response = await fetch(apiUrl);
                    const shortLink = await response.text();
                    if(shortLink.startsWith('http')) { web = shortLink; showToast("Link Kƒ±saltƒ±ldƒ±!", "fa-check"); }
                } catch(e) {}
            }

            const newChannel = {
                title: title,
                m3u_url: m3u || "#",
                web_link_url: web || "#",
                image: img || "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10",
                added_date: new Date().toLocaleDateString('tr-TR'),
                order: parseInt(order) || 9999
            };
            database.ref('channels').push(newChannel);
            showToast("Kanal Eklendi!", "fa-check");
            document.getElementById('addTitle').value = ""; document.getElementById('addM3u').value = ""; document.getElementById('addWeb').value = ""; document.getElementById('addImg').value = "";
        }

        window.deleteChannel = function(key) { if(confirm("Silmek istediƒüine emin misin?")) { database.ref('channels/' + key).remove(); showToast("Silindi", "fa-trash"); } };
        window.openEditModal = function(key) { const item = categoryData.iptv_list.items.find(i => i.firebaseKey === key); if(!item) return; document.getElementById('editKey').value = key; document.getElementById('editTitle').value = item.title; document.getElementById('editM3u').value = item.m3u_url; document.getElementById('editWeb').value = item.web_link_url; document.getElementById('editImg').value = item.image; document.getElementById('editOrder').value = item.order || 9999; document.getElementById('editChannelModal').style.display = 'flex'; };
        window.saveChannelEdit = function() { const key = document.getElementById('editKey').value; database.ref('channels/' + key).update({ title: document.getElementById('editTitle').value, m3u_url: document.getElementById('editM3u').value, web_link_url: document.getElementById('editWeb').value, image: document.getElementById('editImg').value, order: parseInt(document.getElementById('editOrder').value) }); document.getElementById('editChannelModal').style.display = 'none'; showToast("G√ºncellendi", "fa-save"); };

        window.shortenUrl = function(inputId) {
            const url = document.getElementById(inputId).value;
            if(!url || !url.startsWith("http")) { showToast("Ge√ßersiz Link", "fa-exclamation"); return; }
            showToast("Kƒ±saltƒ±lƒ±yor...", "fa-cog fa-spin");
            fetch(`https://ay.live/api/?api=${LINK_API_KEY}&url=${encodeURIComponent(url)}&format=text`).then(r=>r.text()).then(t=>{ if(t.startsWith("http")) { document.getElementById(inputId).value = t; showToast("Kƒ±saltƒ±ldƒ±!", "fa-check"); }});
        };

        // --- RENDER ---
        function render() {
            const container = document.getElementById('list');
            const items = categoryData[activeCategoryKey].items;
            container.innerHTML = '';
            if(items.length === 0) { container.innerHTML = '<p style="text-align:center; opacity:0.5; margin-top:20px;">Kanal yok. Admin Panelinden "Eski Listeyi Y√ºkle" yapƒ±n.</p>'; return; }
            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.setAttribute('data-title', item.title);
                if (index >= currentlyShown) card.classList.add('hidden');
                
                const safeKey = sanitizeKey(item.title);
                const views = globalViewCounts[safeKey] || 0;
                const likes = globalLikeCounts[safeKey] || 0;
                const isLiked = myLikes.includes(safeKey) ? 'liked' : '';
                
                card.innerHTML = `<div class="img-box"><img src="${item.image}" class="card-img" onerror="this.src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4yG_juMJsuYS1fMI3WD6l6yqJTAo80TL3k6NqS2G63PIwAxwarsjUuTE&s=10'"><span class="badge badge-iptv">IPTV</span></div><div class="card-info"><div class="card-name">${item.title}</div><div class="card-meta"><span>${item.added_date||""}</span><span class="stat-badge"><i class="fas fa-eye stat-eye"></i> <span class="count-val-eye">${views}</span></span><span class="stat-badge"><i class="fas fa-heart stat-heart ${isLiked}" onclick="toggleLike(event, '${item.title}')"></i> <span class="count-val-heart">${likes}</span></span></div></div><i class="fas fa-play-circle play-icon"></i>`;
                card.onclick = (e) => { if(e.target.classList.contains('stat-heart')) return; let current = item; incrementViewCount(item.title); document.getElementById('mTitle').innerText = item.title; document.getElementById('modal').style.display = 'flex'; document.getElementById('wuffy').onclick = () => { if(current.m3u_url!="#") window.location.href=`intent://${btoa(current.m3u_url)}#Intent;scheme=xmtv;package=co.wuffy.player;end`; }; document.getElementById('xpola').onclick = () => { if(current.m3u_url!="#") window.location.href=`intent://${btoa(current.m3u_url)}#Intent;scheme=xmtv-m3u;package=com.xpola.player;end`; }; document.getElementById('externalWeb').onclick = () => { if(current.web_link_url && current.web_link_url !== "#") { window.open(current.web_link_url, '_blank'); } }; };
                container.appendChild(card);
            });
            if(items.length > currentlyShown) document.getElementById('loadMoreBtn').classList.remove('hidden'); else document.getElementById('loadMoreBtn').classList.add('hidden');
        }
        function loadMore() { currentlyShown += itemsPerPage; render(); }
        function renderAdminChannelList(items) { const l = document.getElementById('adminChannelList'); l.innerHTML = ""; items.forEach(i => { l.innerHTML += `<div class="channel-item-admin"><div style="flex:1;font-size:0.9rem;"><b>${i.order||0}.</b> ${i.title}</div><div class="channel-actions"><button class="btn-sm btn-edit" onclick="openEditModal('${i.firebaseKey}')"><i class="fas fa-edit"></i></button><button class="btn-sm btn-del" onclick="deleteChannel('${i.firebaseKey}')"><i class="fas fa-trash"></i></button></div></div>`; }); }

        // --- STATS & HELPERS ---
        function sanitizeKey(k) { return (k||"").replace(/[.#$\/\[\]]/g, '_'); }
        function incrementViewCount(t) { database.ref('channel_views/' + sanitizeKey(t)).transaction(c => (c||0)+1); }
        window.toggleLike = function(e, t) { e.stopPropagation(); const k = sanitizeKey(t); if(myLikes.includes(k)) return; myLikes.push(k); localStorage.setItem('my_likes', JSON.stringify(myLikes)); database.ref('channel_likes/'+k).transaction(c=>(c||0)+1); e.target.classList.add('liked'); };
        function listenToStats() { database.ref('channel_views').on('value', s=>{globalViewCounts=s.val()||{};updateStatsDOM()}); database.ref('channel_likes').on('value', s=>{globalLikeCounts=s.val()||{};updateStatsDOM()}); }
        function updateStatsDOM() { document.querySelectorAll('.card').forEach(c=>{ const t=c.getAttribute('data-title'); if(t){ const k=sanitizeKey(t); const v=c.querySelector('.count-val-eye'); const l=c.querySelector('.count-val-heart'); if(v)v.innerText=globalViewCounts[k]||0; if(l)l.innerText=globalLikeCounts[k]||0; } }); }

        // --- SOHBET Sƒ∞STEMƒ∞ (TAMƒ∞R EDƒ∞LDƒ∞) ---
        function listenToChat() {
            database.ref('global_chat').limitToLast(50).on('child_added', (s) => {
                const msg = s.val(); const div = document.createElement('div'); const isMe = msg.user === myUserName;
                div.className = `message-bubble ${isMe ? 'msg-right' : 'msg-left'}`;
                if(msg.isAdminMsg) div.style.border = "1px solid #ffeb3b";
                div.innerHTML = `<span class="msg-user" onclick="openUserActionModal('${msg.uuid}', '${msg.user}', '${s.key}')">${msg.isAdminMsg ? '<span class="msg-admin">üõ°Ô∏è Y√ñNETƒ∞Cƒ∞</span>' : msg.user}</span><div>${msg.text}</div>`;
                document.getElementById('chatContainer').appendChild(div);
                document.getElementById('chatContainer').scrollTop = 99999;
            });
            database.ref('global_chat').on('child_removed', (s) => { 
                // Mesaj silinirse ekrandan kaldƒ±r (Basit yenileme)
                document.getElementById('chatContainer').innerHTML = ""; 
                // child_added tekrar tetikleneceƒüi i√ßin history dolar
            });
        }

        function switchChatTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab === 'global' ? 'tabGlobal' : 'tabPrivate').classList.add('active');
            document.getElementById('viewGlobal').classList.add('hidden');
            document.getElementById('viewPrivateList').classList.add('hidden');
            document.getElementById('viewPrivateConv').classList.add('hidden');

            if(tab === 'global') {
                document.getElementById('viewGlobal').classList.remove('hidden');
                document.getElementById('msgInput').placeholder = "Genel sohbete yaz...";
                currentPrivateRoom = null;
            } else {
                if(currentPrivateRoom) {
                     document.getElementById('viewPrivateConv').classList.remove('hidden');
                } else {
                    document.getElementById('viewPrivateList').classList.remove('hidden');
                }
                document.getElementById('msgInput').placeholder = "√ñzel mesaj yaz...";
                document.getElementById('pmBadge').style.display = 'none';
            }
        }

        function getRoomId(uid1, uid2) { const sorted = [uid1, uid2].sort(); return sorted[0] + "_" + sorted[1]; }

        function startPrivateChat(targetUUID, targetName) {
            if(targetUUID === myUUID) return;
            toggleChat(); document.getElementById('chatModal').classList.add('active');
            currentTargetUser = { uuid: targetUUID, name: targetName };
            currentPrivateRoom = getRoomId(myUUID, targetUUID);
            switchChatTab('private');
            document.getElementById('viewPrivateList').classList.add('hidden');
            document.getElementById('viewPrivateConv').classList.remove('hidden');
            document.getElementById('privateChatUserName').innerText = targetName;
            document.getElementById('privateChatContainer').innerHTML = '';
            
            database.ref('private_chats/' + currentPrivateRoom).limitToLast(50).on('child_added', (s) => {
                const msg = s.val();
                const div = document.createElement('div');
                div.className = `message-bubble ${msg.user === myUserName ? 'msg-right' : 'msg-left'}`;
                div.innerHTML = `<span class="msg-user">${msg.user}</span>${msg.text}`;
                document.getElementById('privateChatContainer').appendChild(div);
                document.getElementById('privateChatContainer').scrollTop = 99999;
            });
        }

        function backToPrivateList() { currentPrivateRoom = null; switchChatTab('private'); }

        function listenToAllPrivateChats() {
            database.ref('user_inbox/' + myUUID).on('value', (s) => {
                const c = document.getElementById('privateChatListContainer'); c.innerHTML = '';
                if(!s.exists()) { c.innerHTML = '<p style="text-align:center;opacity:0.6;">Mesaj yok.</p>'; return; }
                s.forEach(ch => {
                   const d = ch.val(); const uid = ch.key;
                   const div = document.createElement('div'); div.className = 'private-chat-item';
                   div.innerHTML = `<b>${d.name}</b><span>${d.lastMsg}</span>`;
                   div.onclick = () => startPrivateChat(uid, d.name);
                   c.appendChild(div);
                });
                if(currentTab === 'global' && s.numChildren() > 0) document.getElementById('pmBadge').style.display = 'inline-block';
            });
        }

        window.openUserActionModal = function(uuid, name, msgKey) {
            if(uuid === myUUID) return;
            selectedUserForAction = { uuid, name, msgKey };
            document.getElementById('uaTitle').innerText = name;
            document.getElementById('userActionModal').style.display = 'flex';
            if(isAdmin) document.getElementById('adminUserActions').style.display = 'block';
            else document.getElementById('adminUserActions').style.display = 'none';
        };

        window.executeUserAction = function(action) {
            document.getElementById('userActionModal').style.display = 'none';
            if(!selectedUserForAction) return;
            if(action === 'private') startPrivateChat(selectedUserForAction.uuid, selectedUserForAction.name);
            if(action === 'ban' && isAdmin) { database.ref('banned_users/' + selectedUserForAction.uuid).set(true); showToast("Engellendi", "fa-ban"); }
            if(action === 'delete' && isAdmin) { database.ref('global_chat/' + selectedUserForAction.msgKey).remove(); showToast("Silindi", "fa-trash"); }
        };

        window.sendMsg = function() {
            const txt = document.getElementById('msgInput').value.trim();
            if(!txt) return;
            if(txt === ADMIN_PASS) { localStorage.setItem('is_admin', 'true'); location.reload(); return; }
            
            if (currentTab === 'global') {
                const msgData = { user: isAdmin ? "Y√ñNETƒ∞Cƒ∞" : myUserName, text: txt, uuid: myUUID, isAdminMsg: isAdmin, time: Date.now() };
                database.ref('global_chat').push(msgData);
                if(!isAdmin && "8437262061:AAGnhDFIjFqNL5PlUGS33mUaXEMlKd1yyzk" !== "BURAYA") fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage?chat_id=${TG_CHAT_ID}&text=${encodeURIComponent(myUserName + ": " + txt)}`).catch(e=>{});
            } else if (currentTab === 'private' && currentPrivateRoom) {
                database.ref('private_chats/' + currentPrivateRoom).push({ user: myUserName, text: txt, time: Date.now() });
                database.ref('user_inbox/' + currentTargetUser.uuid + '/' + myUUID).set({ lastMsg: txt, timestamp: Date.now(), name: myUserName });
                database.ref('user_inbox/' + myUUID + '/' + currentTargetUser.uuid).set({ lastMsg: "Sen: " + txt, timestamp: Date.now(), name: currentTargetUser.name });
            }
            document.getElementById('msgInput').value = "";
        };

        // --- EXTRAS ---
        function listenToExtras() {
            database.ref('extras').on('value', s => {
                const val = s.val() || {};
                if(val.announcement && val.announcement.active) { document.getElementById('announcementBar').style.display = 'block'; document.getElementById('announcementText').innerText = val.announcement.text; } 
                else { document.getElementById('announcementBar').style.display = 'none'; }
                if(val.maintenance && !isAdmin) document.getElementById('maintenanceScreen').style.display = 'flex';
                else document.getElementById('maintenanceScreen').style.display = 'none';
            });
        }
        function checkBanStatus() { database.ref('banned_users/' + myUUID).on('value', s => { if(s.exists()) document.getElementById('bannedScreen').style.display = 'flex'; }); }
        function initPresence() { 
            const connectedRef = database.ref('.info/connected');
            const onlineRef = database.ref('online_users');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    const con = onlineRef.push();
                    con.onDisconnect().remove();
                    con.set(true);
                }
            });
            onlineRef.on('value', (snap) => { document.getElementById('onlineCount').innerText = snap.numChildren() || 0; });
        }

        // --- HELPER FUNC ---
        window.saveAnnouncement = function() { database.ref('extras/announcement').set({ active: true, text: document.getElementById('annoInput').value }); showToast("Duyuru Yayƒ±nda", "fa-bullhorn"); };
        window.stopAnnouncement = function() { database.ref('extras/announcement').set({active: false}); };
        window.toggleMaintenance = function() { database.ref('extras/maintenance').transaction(val => !val); showToast("Bakƒ±m Modu Deƒüi≈ütirildi", "fa-tools"); };
        window.clearChat = function() { if(confirm("Sohbeti silmek istediƒüine emin misin?")) database.ref('global_chat').remove(); };
        window.openNameModal = function() { document.getElementById('nameChangeModal').style.display='flex'; };
        window.saveName = function() { const n=document.getElementById('newNameInput').value; if(n){ myUserName=n; localStorage.setItem('chat_username',n); document.getElementById('nameChangeModal').style.display='none'; } };
        window.emergencyLogin = function() { if(document.getElementById('emergencyPass').value === ADMIN_PASS) { localStorage.setItem('is_admin', 'true'); location.reload(); } else alert("Yanlƒ±≈ü ≈ûifre"); };
        function showToast(msg, icon) { const t = document.getElementById('toast'); t.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`; t.className = "toast show"; setTimeout(() => t.className = t.className.replace("show", ""), 3000); }
        function openAdminPanel() { document.getElementById('adminPanelModal').style.display = 'flex'; }
        function toggleSubMenu(id) { document.getElementById(id).classList.toggle('active'); }
        function toggleChat() { document.getElementById('chatModal').classList.toggle('active'); }
        function toggleTheme() { document.body.classList.toggle('light-theme'); const isLight = document.body.classList.contains('light-theme'); localStorage.setItem('theme', isLight ? 'light' : 'dark'); document.getElementById('themeBtn').innerHTML = isLight ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; document.getElementById('telegramBtn').style.color = isLight ? '#1a1a1a' : 'white'; }

        init();
    </script>
</body>
</html>